From badf0cb389f59d8502d651645dd40f5255671527 Mon Sep 17 00:00:00 2001
From: Iago Toral Quiroga <itoral@igalia.com>
Date: Fri, 24 Jan 2014 14:32:15 +0100
Subject: [PATCH 10/10] [WAYLAND] When creating the shared EGL display, add
 runtime checks to decide between X11 and Wayland.

---
 .../WebCore/platform/graphics/egl/GLContextEGL.cpp | 28 ++++++++++++++++++++--
 1 file changed, 26 insertions(+), 2 deletions(-)

diff --git a/Source/WebCore/platform/graphics/egl/GLContextEGL.cpp b/Source/WebCore/platform/graphics/egl/GLContextEGL.cpp
index 757a60d..c948955 100644
--- a/Source/WebCore/platform/graphics/egl/GLContextEGL.cpp
+++ b/Source/WebCore/platform/graphics/egl/GLContextEGL.cpp
@@ -35,6 +35,16 @@
 #include "OpenGLShims.h"
 #endif
 
+#if PLATFORM(GTK)
+#include <gdk/gdk.h>
+#ifdef GDK_WINDOWING_X11
+#include <gdk/gdkx.h>
+#endif
+#ifdef GDK_WINDOWING_WAYLAND
+#include <gdk/gdkwayland.h>
+#endif
+#endif
+
 #if ENABLE(ACCELERATED_2D_CANVAS)
 #include <cairo-gl.h>
 #endif
@@ -54,13 +64,27 @@ static EGLDisplay sharedEGLDisplay()
     static bool initialized = false;
     if (!initialized) {
         initialized = true;
-#if PLATFORM(GTK) && PLATFORM(WAYLAND) && !defined(GTK_API_VERSION_2)
+#if PLATFORM(GTK) && !defined(GTK_API_VERSION_2)
+    GdkDisplay* display = gdk_display_manager_get_default_display(gdk_display_manager_get());
+#if PLATFORM(WAYLAND) && defined(GDK_WINDOWING_WAYLAND)
+    if (GDK_IS_WAYLAND_DISPLAY(display))
         gSharedEGLDisplay = eglGetDisplay(GLContext::sharedWaylandDisplay());
-#elif PLATFORM(X11)
+#endif
+    // Can't have X11 path go through EGL when we are building also for Wayland
+    // target, must use GLX to create the context in that case
+#if !PLATFORM(WAYLAND) && PLATFORM(X11) && defined(GDK_WINDOWING_X11)
+    if (GDK_IS_X11_DISPLAY(display))
+        gSharedEGLDisplay = eglGetDisplay(GLContext::sharedX11Display());
+#endif
+    if (gSharedEGLDisplay == EGL_NO_DISPLAY)
+        gSharedEGLDisplay = eglGetDisplay(EGL_DEFAULT_DISPLAY);
+#else // PLATFORM(GTK) && !defined(GTK_API_VERSION_2)
+#if PLATFORM(X11)
         gSharedEGLDisplay = eglGetDisplay(GLContext::sharedX11Display());
 #else
         gSharedEGLDisplay = eglGetDisplay(EGL_DEFAULT_DISPLAY);
 #endif
+#endif
         if (gSharedEGLDisplay != EGL_NO_DISPLAY && (!eglInitialize(gSharedEGLDisplay, 0, 0) || !eglBindAPI(gGLAPI)))
             gSharedEGLDisplay = EGL_NO_DISPLAY;
     }
-- 
1.8.3.2

