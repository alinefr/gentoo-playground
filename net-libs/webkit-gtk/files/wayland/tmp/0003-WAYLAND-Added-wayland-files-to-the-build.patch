From 3e87e211131e48a73b0112b58dbbc9f630d1e93d Mon Sep 17 00:00:00 2001
From: Iago Toral Quiroga <itoral@igalia.com>
Date: Wed, 22 Jan 2014 13:41:48 +0100
Subject: [PATCH 03/10] [WAYLAND] Added wayland files to the build

---
 Source/WebCore/GNUmakefile.am        |  1 +
 Source/WebCore/GNUmakefile.list.am   | 10 +++++++++-
 Source/WebKit/gtk/GNUmakefile.am     |  2 ++
 Source/WebKit2/GNUmakefile.am        |  2 ++
 Source/autotools/FindDependencies.m4 |  7 +++++++
 5 files changed, 21 insertions(+), 1 deletion(-)

diff --git a/Source/WebCore/GNUmakefile.am b/Source/WebCore/GNUmakefile.am
index 21a08fc..3d94fe5 100644
--- a/Source/WebCore/GNUmakefile.am
+++ b/Source/WebCore/GNUmakefile.am
@@ -618,6 +618,7 @@ libWebCoreGtk_la_CPPFLAGS = \
 	$(GLIB_CFLAGS) \
 	$(GSTREAMER_CFLAGS) \
 	$(GTK_CFLAGS) \
+	$(GTK_WAYLAND_CFLAGS) \
 	$(LIBSECRET_CFLAGS) \
 	$(LIBSOUP_CFLAGS) \
 	$(LIBXML_CFLAGS) \
diff --git a/Source/WebCore/GNUmakefile.list.am b/Source/WebCore/GNUmakefile.list.am
index c9a2dfa..02db0dd 100644
--- a/Source/WebCore/GNUmakefile.list.am
+++ b/Source/WebCore/GNUmakefile.list.am
@@ -6287,7 +6287,15 @@ platformgtk_sources += \
 	Source/WebCore/platform/graphics/GLContext.cpp \
 	Source/WebCore/platform/graphics/GLContext.h \
 	Source/WebCore/platform/gtk/RedirectedXCompositeWindow.cpp \
-	Source/WebCore/platform/gtk/RedirectedXCompositeWindow.h
+	Source/WebCore/platform/gtk/RedirectedXCompositeWindow.h \
+	Source/WebCore/platform/gtk/WaylandCompositor.cpp \
+	Source/WebCore/platform/gtk/WaylandCompositor.h \
+	Source/WebCore/platform/gtk/WaylandDisplayEventSource.cpp \
+	Source/WebCore/platform/gtk/WaylandDisplayEventsource.h \
+	Source/WebCore/platform/gtk/WaylandDisplay.cpp \
+	Source/WebCore/platform/gtk/WaylandDisplay.h \
+	Source/WebCore/platform/gtk/WaylandSurface.cpp \
+	Source/WebCore/platform/gtk/WaylandSurface.h
 endif # END USE_OPENGL
 if USE_EGL
 webcoregtk_sources += \
diff --git a/Source/WebKit/gtk/GNUmakefile.am b/Source/WebKit/gtk/GNUmakefile.am
index 4ff4656..e1c6248 100644
--- a/Source/WebKit/gtk/GNUmakefile.am
+++ b/Source/WebKit/gtk/GNUmakefile.am
@@ -62,6 +62,7 @@ libwebkitgtk_@WEBKITGTK_API_MAJOR_VERSION@_@WEBKITGTK_API_MINOR_VERSION@_la_CPPF
 	$(GLIB_CFLAGS) \
 	$(GSTREAMER_CFLAGS) \
 	$(GTK_CFLAGS) \
+	$(GTK_WAYLAND_CFLAGS) \
 	$(LIBSOUP_CFLAGS) \
 	$(LIBXML_CFLAGS) \
 	$(SQLITE3_CFLAGS) \
@@ -116,6 +117,7 @@ libwebkitgtk_@WEBKITGTK_API_MAJOR_VERSION@_@WEBKITGTK_API_MINOR_VERSION@_la_LIBA
 	$(GLIB_LIBS) \
 	$(GSTREAMER_LIBS) \
 	$(GTK_LIBS) \
+	$(GTK_WAYLAND_LIBS) \
 	$(JPEG_LIBS) \
 	$(LIBSECRET_LIBS) \
 	$(LIBSOUP_LIBS) \
diff --git a/Source/WebKit2/GNUmakefile.am b/Source/WebKit2/GNUmakefile.am
index 18177c3..d156813 100644
--- a/Source/WebKit2/GNUmakefile.am
+++ b/Source/WebKit2/GNUmakefile.am
@@ -204,6 +204,7 @@ libwebkit2gtk_@WEBKITGTK_API_MAJOR_VERSION@_@WEBKITGTK_API_MINOR_VERSION@_la_CPP
 	$(GEOCLUE_CFLAGS) \
 	$(GLIB_CFLAGS) \
 	$(GTK_CFLAGS) \
+	$(GTK_WAYLAND_CFLAGS) \
 	$(GTK_UNIX_PRINTING_CFLAGS) \
 	$(LIBSOUP_CFLAGS) \
 	$(UNICODE_CFLAGS) \
@@ -274,6 +275,7 @@ libwebkit2gtk_@WEBKITGTK_API_MAJOR_VERSION@_@WEBKITGTK_API_MINOR_VERSION@_la_LIB
 	$(GLIB_LIBS) \
 	$(GSTREAMER_LIBS) \
 	$(GTK_LIBS) \
+	$(GTK_WAYLAND_LIBS) \
 	$(GTK_UNIX_PRINTING_LIBS) \
 	$(JPEG_LIBS) \
 	$(LIBSECRET_LIBS) \
diff --git a/Source/autotools/FindDependencies.m4 b/Source/autotools/FindDependencies.m4
index efc2db3..7347c4f 100644
--- a/Source/autotools/FindDependencies.m4
+++ b/Source/autotools/FindDependencies.m4
@@ -206,6 +206,9 @@ if test "$enable_wayland_target" != "no"; then
     PKG_CHECK_MODULES([GTK_WAYLAND], [
         gtk+-wayland-$GTK_API_VERSION = $GTK_ACTUAL_VERSION
         gtk+-wayland-$GTK_API_VERSION >= gtk3_wayland_required_version
+        wayland-client >= 1.3.9
+        wayland-server >= 1.3.9
+        wayland-egl >= 10.1.0
     ], [enable_wayland_target=yes], [
         if test "$enable_wayland_target" = "yes"; then
             AC_MSG_ERROR([GTK+ Wayland dependency (gtk+-wayland-$GTK_API_VERSION >= gtk3_wayland_required_version) not found.])
@@ -216,6 +219,10 @@ if test "$enable_wayland_target" != "no"; then
     ])
 fi
 
+# @FIXME: not sure if this is necessary
+AC_SUBST(GTK_WAYLAND_CFLAGS)
+AC_SUBST(GTK_WAYLAND_LIBS)
+
 AC_CHECK_HEADERS([GL/glx.h], [have_glx="yes"], [have_glx="no"])
 AC_MSG_CHECKING([whether to enable GLX support])
 if test "$enable_glx" != "no"; then
-- 
1.8.3.2

